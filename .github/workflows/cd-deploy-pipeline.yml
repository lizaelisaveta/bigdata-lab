name: CD - Deploy and Test Staging

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Pull latest image
      run: docker pull ${{ secrets.DOCKERHUB_USERNAME }}/dogs-vs-cats-api:latest

    - name: Run Container
      run: |
        docker run -d -p 8000:8000 --name ml-api-test ${{ secrets.DOCKERHUB_USERNAME }}/dogs-vs-cats-api:latest
        sleep 10

    - name: Run Integration Tests against Live API
      run: |
        cd tests/
        API_URL="http://localhost:8000" pytest test_api_integration.py -v

    - name: Stop and Remove Container
      run: |
        docker stop ml-api-test
        docker rm ml-api-test

    - name: Log Test Results
      run: |
        echo "âœ… Functional testing completed successfully!"
